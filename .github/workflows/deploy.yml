name: Deploy WordPress Docker to AWS with ECR

on:
  push:
    branches: [master, main]
  workflow_dispatch:

# Required for OIDC authentication
permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    env:
      AWS_REGION: us-east-1
      ECR_REPOSITORY: abdu-wordpress
      ASG_NAME: abdullatif-asg
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
        
      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1
          role-session-name: GitHubActions-WordPressDeployment
      
      - name: Verify AWS Identity
        run: |
          echo "ðŸ” Verifying AWS credentials..."
          aws sts get-caller-identity
          echo "âœ… AWS authentication successful"
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "ðŸ³ Building Docker image..."
          
          # Build the Docker image
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          
          echo "ðŸ“¦ Pushing image to ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          
          echo "âœ… Image pushed successfully"
          echo "Image: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
          
          # Export for later steps
          echo "IMAGE_URI=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_ENV
          echo "ECR_REGISTRY=$ECR_REGISTRY" >> $GITHUB_ENV
      
      - name: Update SSM Parameters with Image Information
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "ðŸ”§ Updating SSM Parameters with new image information..."
          

          # Update SSM Parameters with new image information
          aws ssm put-parameter \
            --name "/abdu_app/IMAGE_TAG" \
            --value "$IMAGE_TAG" \
            --type "String" \
            --overwrite \
            --region $AWS_REGION
          
          echo "âœ… SSM Parameters updated successfully"
          echo "   ECR_REGISTRY: $ECR_REGISTRY"
          echo "   ECR_REPOSITORY: $ECR_REPOSITORY"
          echo "   IMAGE_TAG: $IMAGE_TAG"
      
     
      # Refresh auto group instances to pull new image
      - name: Refresh Auto Group Instances
        run: |
          echo "Refreshing Auto Group Instances..."
          aws autoscaling start-instance-refresh \
            --auto-scaling-group-name $ASG_NAME \
            --preferences '{"MinHealthyPercentage": 50}'
      
      - name: Cleanup old ECR images
        if: success()
        run: |
          echo "ðŸ§¹ Cleaning up old ECR images (keeping last 10)..."
          
          # Get image digests sorted by push date, skip the first 10 (most recent)
          IMAGES_TO_DELETE=$(aws ecr describe-images \
            --repository-name $ECR_REPOSITORY \
            --query 'sort_by(imageDetails,& imagePushedAt)[:-10].imageDigest' \
            --output text)
          
          if [ ! -z "$IMAGES_TO_DELETE" ]; then
            for digest in $IMAGES_TO_DELETE; do
              echo "Deleting image: $digest"
              aws ecr batch-delete-image \
                --repository-name $ECR_REPOSITORY \
                --image-ids imageDigest=$digest || true
            done
            echo "âœ… Old images cleaned up"
          else
            echo "No old images to delete"
          fi

   
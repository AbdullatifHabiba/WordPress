name: Deploy WordPress Docker to AWS with ECR

on:
  push:
    branches: [master, main]
  workflow_dispatch:

# Required for OIDC authentication
permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    env:
      AWS_REGION: us-east-1
      ECR_REPOSITORY: abdu-wordpress
      ASG_NAME: abdullatif-asg
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
        
      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1
          role-session-name: GitHubActions-WordPressDeployment
      
      - name: Verify AWS Identity
        run: |
          echo "üîê Verifying AWS credentials..."
          aws sts get-caller-identity
          echo "‚úÖ AWS authentication successful"
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "üê≥ Building Docker image..."
          
          # Build the Docker image
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          
          echo "üì¶ Pushing image to ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          
          echo "‚úÖ Image pushed successfully"
          echo "Image: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
          
          # Export for later steps
          echo "IMAGE_URI=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_ENV
          echo "ECR_REGISTRY=$ECR_REGISTRY" >> $GITHUB_ENV
      
      - name: Update SSM Parameters with Image Information
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "üîß Updating SSM Parameters with new image information..."
          

          
          aws ssm put-parameter \
            --name "/abdu_app/IMAGE_TAG" \
            --value "$IMAGE_TAG" \
            --type "String" \
            --overwrite \
            --region $AWS_REGION
          
          echo "‚úÖ SSM Parameters updated successfully"
          echo "   ECR_REGISTRY: $ECR_REGISTRY"
          echo "   ECR_REPOSITORY: $ECR_REPOSITORY"
          echo "   IMAGE_TAG: $IMAGE_TAG"
      
      - name: Verify Docker configurations in repository
        run: |
          echo "‚úÖ Docker configurations verified"
          echo "   - docker-compose.yml (available in repository)"
          echo "   - nginx.conf (available in repository)"
          echo "   - user-data.sh fetches credentials from SSM on instance startup"
      
     
      # - name: Create and upload deployment script
      #   run: |
      #     echo "üìù Creating deployment script using SSM Parameter Store..."
          
      #     cat > deploy-ecr.sh << 'DEPLOY_SCRIPT'
      #     #!/bin/bash
      #     set -e
          
      #     TIMESTAMP=$(date "+%Y-%m-%d %H:%M:%S")
      #     AWS_REGION="us-east-1"
      #     echo "=========================================="
      #     echo "[$TIMESTAMP] Starting Docker deployment on $(hostname)"
      #     echo "=========================================="
          
      #     cd /opt/wordpress
          
      #     # Fetch ECR configuration from SSM Parameter Store
      #     echo "[$TIMESTAMP] Fetching ECR configuration from SSM Parameter Store..."
      #     ECR_REGISTRY=$(aws ssm get-parameter --name "/abdu_app/ECR_REGISTRY" --query "Parameter.Value" --output text --region $AWS_REGION)
      #     ECR_REPOSITORY=$(aws ssm get-parameter --name "/abdu_app/ECR_REPOSITORY" --query "Parameter.Value" --output text --region $AWS_REGION)
      #     IMAGE_TAG=$(aws ssm get-parameter --name "/abdu_app/IMAGE_TAG" --query "Parameter.Value" --output text --region $AWS_REGION)
          
      #     if [ -z "$ECR_REGISTRY" ] || [ -z "$ECR_REPOSITORY" ] || [ -z "$IMAGE_TAG" ]; then
      #       echo "[$TIMESTAMP] ‚ùå ERROR: Failed to retrieve complete ECR configuration from SSM"
      #       exit 1
      #     fi
          
      #     echo "[$TIMESTAMP] ‚úÖ Retrieved ECR configuration from SSM"
      #     echo "[$TIMESTAMP]    Registry: $ECR_REGISTRY"
      #     echo "[$TIMESTAMP]    Repository: $ECR_REPOSITORY"
      #     echo "[$TIMESTAMP]    Image Tag: $IMAGE_TAG"
          
      #     # Login to ECR
      #     echo "[$TIMESTAMP] Logging into Amazon ECR..."
      #     aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY
          
      #     # Pull the new image
      #     echo "[$TIMESTAMP] Pulling new image from ECR..."
      #     docker pull $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          
      #     # Stop and remove old containers
      #     echo "[$TIMESTAMP] Stopping existing containers..."
      #     docker compose down || true
          
      #     # Remove old images (keep last 3)
      #     echo "[$TIMESTAMP] Cleaning up old images..."
      #     docker images $ECR_REGISTRY/$ECR_REPOSITORY --format "{{.ID}} {{.Tag}}" | \
      #       grep -v "$IMAGE_TAG" | \
      #       tail -n +4 | awk '{print $1}' | xargs -r docker rmi || true
          
      #     # Start containers with new image
      #     echo "[$TIMESTAMP] Starting containers with new image..."
      #     docker compose up -d
          
      #     # Wait for containers to be healthy
      #     echo "[$TIMESTAMP] Waiting for containers to be healthy..."
      #     sleep 60
          
      #     # Check health status
      #     MAX_ATTEMPTS=12
      #     ATTEMPT=0
          
      #     while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
      #       WP1_HEALTH=$(docker inspect wordpress-app-1 --format='{{.State.Health.Status}}' 2>/dev/null || echo "unknown")
      #       WP2_HEALTH=$(docker inspect wordpress-app-2 --format='{{.State.Health.Status}}' 2>/dev/null || echo "unknown")
      #       NGINX_HEALTH=$(docker inspect wordpress-lb --format='{{.State.Health.Status}}' 2>/dev/null || echo "unknown")
            
      #       echo "[$TIMESTAMP] Health status - WP1: $WP1_HEALTH, WP2: $WP2_HEALTH, Nginx: $NGINX_HEALTH"
            
      #       if [ "$WP1_HEALTH" = "healthy" ] && [ "$WP2_HEALTH" = "healthy" ] && [ "$NGINX_HEALTH" = "healthy" ]; then
      #         echo "[$TIMESTAMP] ‚úÖ All containers are healthy"
      #         break
      #       fi
            
      #       ATTEMPT=$((ATTEMPT + 1))
      #       echo "[$TIMESTAMP] Waiting for containers to become healthy (attempt $ATTEMPT/$MAX_ATTEMPTS)..."
      #       sleep 10
      #     done
          
      #     # Verify deployment
      #     echo "[$TIMESTAMP] Verifying deployment..."
      #     if curl -sf http://localhost/health > /dev/null; then
      #       echo "[$TIMESTAMP] ‚úÖ Health check passed"
      #     else
      #       echo "[$TIMESTAMP] ‚ö†Ô∏è Health check warning"
      #     fi
          
      #     # Show container status
      #     echo "[$TIMESTAMP] Container status:"
      #     docker compose ps
          
      #     # Show current image tags
      #     echo "[$TIMESTAMP] Current images:"
      #     docker images $ECR_REGISTRY/$ECR_REPOSITORY
          
      #     echo "=========================================="
      #     echo "[$TIMESTAMP] ‚úÖ Deployment completed successfully on $(hostname)"
      #     echo "[$TIMESTAMP] Deployed image: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
      #     echo "=========================================="
      #     DEPLOY_SCRIPT
          
      #     # Upload script to S3 for historical reference (optional)
      #     SCRIPT_NAME="deploy-ecr-$(date +%s).sh"
      #     aws s3 cp deploy-ecr.sh s3://abdullatif-app/scripts/$SCRIPT_NAME --storage-class STANDARD_IA || true
      #     aws s3 cp deploy-ecr.sh s3://abdullatif-app/scripts/latest-deploy-ecr.sh --storage-class STANDARD_IA || true
      #     echo "SCRIPT_NAME=$SCRIPT_NAME" >> $GITHUB_ENV
      #     echo "‚úÖ Deployment script created (SSM-based)"
       # - name: Get Auto Scaling Group Instances
      #   id: get-instances
      #   run: |
      #     echo "üîç Finding instances in Auto Scaling Group..."
          
      #     # Get healthy instances from ASG
      #     INSTANCE_IDS=$(aws autoscaling describe-auto-scaling-groups \
      #       --auto-scaling-group-names $ASG_NAME \
      #       --query 'AutoScalingGroups[0].Instances[?LifecycleState==`InService`].InstanceId' \
      #       --output text)
          
      #     if [ -z "$INSTANCE_IDS" ]; then
      #       echo "‚ùå No healthy instances found in Auto Scaling Group!"
      #       exit 1
      #     fi
          
      #     echo "INSTANCE_IDS=$INSTANCE_IDS" >> $GITHUB_ENV
      #     echo "‚úÖ Found healthy instances: $INSTANCE_IDS"
          
      #     # Get instance details
      #     for INSTANCE_ID in $INSTANCE_IDS; do
      #       PRIVATE_IP=$(aws ec2 describe-instances \
      #         --instance-ids "$INSTANCE_ID" \
      #         --query 'Reservations[0].Instances[0].PrivateIpAddress' \
      #         --output text)
      #       echo "   Instance $INSTANCE_ID: $PRIVATE_IP"
      #     done
      
      # - name: Deploy to instances
      #   run: |
      #     echo "üöÄ Starting deployment to Docker instances..."
          
      #     SUCCESS_COUNT=0
      #     TOTAL_INSTANCES=$(echo $INSTANCE_IDS | wc -w)
          
      #     for INSTANCE_ID in $INSTANCE_IDS; do
      #       echo "=========================================="
      #       echo "üöÄ Deploying to instance: $INSTANCE_ID"
      #       echo "=========================================="
            
      #       COMMAND_ID=$(aws ssm send-command \
      #         --instance-ids "$INSTANCE_ID" \
      #         --document-name "AWS-RunShellScript" \
      #         --parameters commands="[
      #           \"aws s3 cp s3://abdullatif-app/scripts/$SCRIPT_NAME /tmp/deploy-ecr.sh\",
      #           \"chmod +x /tmp/deploy-ecr.sh\",
      #           \"/tmp/deploy-ecr.sh\",
      #           \"rm -f /tmp/deploy-ecr.sh\"
      #         ]" \
      #         --timeout-seconds 900 \
      #         --output text \
      #         --query 'Command.CommandId')
            
      #       echo "   Command ID: $COMMAND_ID"
      #       echo "   ‚è≥ Waiting for deployment to complete..."
            
      #       # Wait for command to complete
      #       aws ssm wait command-executed \
      #         --command-id "$COMMAND_ID" \
      #         --instance-id "$INSTANCE_ID" \
      #         --cli-read-timeout 900 || true
            
      #       # Get command status
      #       COMMAND_STATUS=$(aws ssm get-command-invocation \
      #         --command-id "$COMMAND_ID" \
      #         --instance-id "$INSTANCE_ID" \
      #         --query 'Status' \
      #         --output text)
            
      #       if [ "$COMMAND_STATUS" = "Success" ]; then
      #         echo "   ‚úÖ Deployment successful on $INSTANCE_ID"
      #         SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              
      #         # Show last 20 lines of output
      #         echo "   üìã Deployment output:"
      #         aws ssm get-command-invocation \
      #           --command-id "$COMMAND_ID" \
      #           --instance-id "$INSTANCE_ID" \
      #           --query 'StandardOutputContent' \
      #           --output text | tail -20
      #       else
      #         echo "   ‚ùå Deployment failed on $INSTANCE_ID (Status: $COMMAND_STATUS)"
              
      #         echo "   üìã Error output:"
      #         aws ssm get-command-invocation \
      #           --command-id "$COMMAND_ID" \
      #           --instance-id "$INSTANCE_ID" \
      #           --query 'StandardErrorContent' \
      #           --output text | head -30
      #       fi
            
      #       echo ""
      #     done
          
      #     # Cleanup script from S3
      #     aws s3 rm s3://abdullatif-app/scripts/$SCRIPT_NAME || true
          
      #     echo "=========================================="
      #     echo "üìä Deployment Summary"
      #     echo "=========================================="
      #     echo "   Docker Image: $IMAGE_URI"
      #     echo "   Total instances: $TOTAL_INSTANCES"
      #     echo "   Successful: $SUCCESS_COUNT"
      #     echo "   Failed: $((TOTAL_INSTANCES - SUCCESS_COUNT))"
      #     echo "=========================================="
          
      #     if [ $SUCCESS_COUNT -eq 0 ]; then
      #       echo "‚ùå All deployments failed!"
      #       exit 1
      #     elif [ $SUCCESS_COUNT -lt $TOTAL_INSTANCES ]; then
      #       echo "‚ö†Ô∏è Partial deployment - some instances failed"
      #       exit 1
      #     else
      #       echo "‚úÖ All deployments completed successfully!"
      #     fi
      # Refresh auto group instances to pull new image
      - name: Refresh Auto Group Instances
        run: |
          echo "Refreshing Auto Group Instances..."
          aws autoscaling start-instance-refresh \
            --auto-scaling-group-name $ASG_NAME \
            --preferences '{"MinHealthyPercentage": 50}'
      
      - name: Cleanup old ECR images
        if: success()
        run: |
          echo "üßπ Cleaning up old ECR images (keeping last 10)..."
          
          # Get image digests sorted by push date, skip the first 10 (most recent)
          IMAGES_TO_DELETE=$(aws ecr describe-images \
            --repository-name $ECR_REPOSITORY \
            --query 'sort_by(imageDetails,& imagePushedAt)[:-10].imageDigest' \
            --output text)
          
          if [ ! -z "$IMAGES_TO_DELETE" ]; then
            for digest in $IMAGES_TO_DELETE; do
              echo "Deleting image: $digest"
              aws ecr batch-delete-image \
                --repository-name $ECR_REPOSITORY \
                --image-ids imageDigest=$digest || true
            done
            echo "‚úÖ Old images cleaned up"
          else
            echo "No old images to delete"
          fi

   